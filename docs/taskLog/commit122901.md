# Commit Log - 2025-12-29-01

## Commit Message

```
refactor: Implement Multi-Provider OAuth schema and remove deprecated code

Refactor database schema and backend code to support multiple OAuth
providers (Google, Naver, Line, Apple, Kakao, GitHub). Replace single
`google_id` column with `provider` + `provider_id` composite structure.

This is a breaking change that requires database migration before
deployment. See docs/MIGRATION_GUIDE.md for migration instructions.

Changes:
- Add `provider` (VARCHAR) and `provider_id` (VARCHAR) columns
- Add composite UNIQUE constraint on (provider, provider_id)
- Add `findUserByProvider()` function replacing `findUserByGoogleId()`
- Update `createUser()` signature to accept provider parameter
- Remove deprecated `findUserByGoogleId()` function completely
- Update all tests to use new provider/provider_id structure
- Add migration scripts and rollback support
```

## Changes

### Database (A: Added)

| File | Description |
|------|-------------|
| `database/migrations/001_multi_provider.sql` | Migration script for provider columns |
| `database/migrations/001_multi_provider_rollback.sql` | Rollback script |

### Database (M: Modified)

| File | Description |
|------|-------------|
| `database/schema.sql` | Add provider, provider_id columns with CHECK constraint |

### Backend (M: Modified)

| File | Description |
|------|-------------|
| `backend/src/db/queries.ts` | AuthProvider type, findUserByProvider(), removed findUserByGoogleId() |
| `backend/src/services/passport.ts` | Use findUserByProvider('google', ...) |
| `backend/src/types/express.d.ts` | Update User type with provider fields |

### Tests (M: Modified)

| File | Description |
|------|-------------|
| `backend/src/__tests__/middleware/auth.test.ts` | Update mockUser with provider/provider_id |
| `backend/src/__tests__/routes/verify.test.ts` | Update mockUser with provider/provider_id |
| `backend/src/__tests__/services/jwt.test.ts` | Update mockUser and sensitive data test |

### Documentation (A: Added, M: Modified)

| File | Description |
|------|-------------|
| `docs/MIGRATION_GUIDE.md` | New migration guide for existing projects |
| `docs/BACKEND_STRUCTURE.md` | Updated schema and function documentation |
| `docs/current_sprint/order122801.md` | Order file with completion status |

## Verification

| Step | Command | Result |
|------|---------|--------|
| Build | `npm run build` | Success |
| Test | `npm test` | 44 passed, 4 skipped |

## Breaking Changes

| Item | Before | After |
|------|--------|-------|
| `User.google_id` | `string` | Removed |
| `User.provider` | - | `'google' \| 'naver' \| 'line' \| ...` |
| `User.provider_id` | - | `string` |
| `findUserByGoogleId()` | Available | Removed |
| `createUser()` | `(googleId, email, ...)` | `(provider, providerId, email, ...)` |

## Migration Required

Before deploying, run the database migration:

```bash
# Backup first
pg_dump -h localhost -U postgres auth > backup_$(date +%Y%m%d).sql

# Run migration
psql -h localhost -U postgres -d auth -f database/migrations/001_multi_provider.sql
```

## Related

- Order file: `docs/current_sprint/order122801.md`
- Migration guide: `docs/MIGRATION_GUIDE.md`
